# TopologyChangeGenerator
This repository contains code to produce a collection of topology changes based on [OpenCelliD](https://opencellid.org/) database and GTFS schedule of [VBB](https://www.vbb.de/vbb-services/api-open-data/datensaetze/). This generator is used for investigating the effect of mobile infrastructure on the runtime perfromance of NebulaStream. We have a publication under submission. In the future, we will add the link to the accepted version of the paper. 

# Pre-Processing Steps

1. Download the GTFS schedule from VBB link provided above. The schedule information is used for finding the trajectory of mobile devices.
2. Create a SQLite database from the gtfs schedule using the tool [gtfsdb tool](https://github.com/OpenTransitTools/gtfsdb) using the bellow commands and place the database at the root of the project.
```  
   pip install zc.buildout
   git clone https://github.com/OpenTransitTools/gtfsdb.git
   cd gtfsdb/
   buildout install prod
   bin/gtfsdb-load --database_url sqlite:///vbb_gtfs.db <location of gtfs file>/GTFS.zip
```   
3. Install Rust toolchain (`curl --proto '=https' --tlsv1.3 https://sh.rustup.rs -sSf | sh` for ubuntu 22.04 LTS).


# Execution

Run the command to build and generate the experiment files `cargo run --release`

# Parameters

### Gtfs Database parameters

```yaml
dbPath: Path to the gtfs database
```

### Parameters for schedule selection

```yaml
start_time                : The time of the day from when the schedule needs to be selected  
end_time                  : The time of the day till when the schedule needs to be selected
day                       : The day of the week for which the schedule needs to be selected 
batchIntervalSizeInSeconds: The time interval in seconds that need to be represented by one second. 
                            This parameter allows us to speedup the time to increase the rate of topology changes.
changeFrequencyInSeconds  : The frequency at which the topology changes need to be produced;
```

### Parameters to store output files

```yaml
topology_path: Path to the file where fixed_topology.json will be produced
topology_updates_path: Path to the file where topology_updates.json will be produced
geo_json_path: Path to the file where geo.json will be produced
```

### Parameters for selecting the base stations

```yaml
file_path: Name of the csv file containing OpenCelliD data.
networkIdentifier: The network identifier for a network provider whose cell towers need to be selected.
min_samples: The number of people connected to the base station.
radio: The type of network the base station support. We use LTE only for our experiments.
```

## Output Files

**geo.json**: This file that can be used to plot on a map the whole experiment setup.

**fixed_topology.json**: This file contains the geographical location of the mobile towers. This information is used to decide the connection point of the mobile node.

Example output:

```json
{
  "nodes": {
    "<node_id>": [
      lat,
      lon
    ],
    ...
  },
  "slots": {
    "<node_id>": <num_of_slots>,
    ...
  },
  "children": {
    "<node_id>": [],
    ...
  }
}

```

**topology_updates.json**: This file contains the topology changes generated by the tool. NebulaStream consumes these changes to mimic the disconnection and reconnection of topology nodes. 

Example output:

```json
{
"initial_parents": [
    [
    <source_node_id>,
    <parent_node_id>
    ],
    ...
],
"topology_updates": [
{
    "timestamp": <time_when_the_change_is_to_be_triggered>,
    "events": [
        {
        "parentId": <old_parent_node_id>,
        "childId": <mobile_node_id>,
        "action": "remove"
        },
        {
        "parentId": <new_parent_node_id>,
        "childId": <mobile_node_id>,
        "action": "add"
        }
      ]
},
    ...
]
}
```

## Acknowledgement
The OpenCelliD database file in the project is downloaded from https://opencellid.org under Creative Commons License. OpenCelliD Project is licensed under a Creative Commons Attribution-ShareAlike 4.0 International License
